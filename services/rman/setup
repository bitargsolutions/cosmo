#!/usr/bin/env node

import fs from "node:fs";
import path from "node:path";

function checkMode() {
	const supportedModes = ["dev", "prod"];
	const envMode = process.env.MODE ?? "";

	if (supportedModes.includes(envMode)) {
		mode = envMode;
		return true;
	}

	return false;
}

var defs = {
	COSMO_LOGGER: import.meta.env?.COSMO_LOGGER,
	MODE: import.meta.env?.MODE,
	MARIADB_HOST: import.meta.env?.MARIADB_HOST,
	MARIADB_DATABASE: import.meta.env?.MARIADB_DATABASE,
	MARIADB_USER: import.meta.env?.MARIADB_USER,
	MARIADB_PASSWORD: import.meta.env?.MARIADB_PASSWORD,
	MARIADB_ROOT_PASSWORD: import.meta.env?.MARIADB_ROOT_PASSWORD,
	SECRET_KEY: process.env?.SECRET_KEY
};

/*
Set the init.sql
*/

function setupSQL() {
	if (defs.SECRET_KEY?.length !== 128) {
		console.log("env: SECRET_KEY is not valid");
		return process.exit(1);
	}

	const initPath = path.resolve(
		import.meta.dirname,
		"src",
		"repos",
		"mariadb"
	);

	const srcInit = path.resolve(initPath, "init.template.sql");
	const dstInit = path.resolve(initPath, "init.sql");

	const content = fs.readFileSync(srcInit, { encoding: "utf-8" });
	const newContent =
		`-- THIS FILE WAS AUTOGENERATED. MODIFICATION MAY BE OVERWRITTEN.\n\n${content}`.replaceAll(
			"#SECRET_HASH#",
			defs.SECRET_KEY
		);

	fs.writeFileSync(dstInit, newContent);
}

function main() {
	if (!checkMode()) {
		console.log("env: MODE is not valid. Must be: dev, prod");
		return;
	}

	setupSQL();
}

main();
